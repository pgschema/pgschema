Plan: 6 to modify.

Summary by type:
  tables: 6 to modify

Tables:
  ~ department
    + department_dept_name_key (constraint)
  ~ dept_emp
    - dept_emp_dept_no_fkey (constraint)
    + dept_emp_dept_no_fkey (constraint)
    - dept_emp_emp_no_fkey (constraint)
    + dept_emp_emp_no_fkey (constraint)
  ~ dept_manager
    - dept_manager_dept_no_fkey (constraint)
    + dept_manager_dept_no_fkey (constraint)
    - dept_manager_emp_no_fkey (constraint)
    + dept_manager_emp_no_fkey (constraint)
  ~ employee
    + employee_gender_check (constraint)
    + idx_employee_hire_date (index)
  ~ salary
    - salary_emp_no_fkey (constraint)
    + salary_emp_no_fkey (constraint)
    + idx_salary_amount (index)
  ~ title
    - title_emp_no_fkey (constraint)
    + title_emp_no_fkey (constraint)

DDL to be executed:
--------------------------------------------------

-- Transaction Group #1
ALTER TABLE department
ADD CONSTRAINT department_dept_name_key UNIQUE (dept_name);

ALTER TABLE dept_emp DROP CONSTRAINT dept_emp_dept_no_fkey;

ALTER TABLE dept_emp
ADD CONSTRAINT dept_emp_dept_no_fkey FOREIGN KEY (dept_no) REFERENCES department(dept_no) ON DELETE CASCADE NOT VALID;

ALTER TABLE dept_emp VALIDATE CONSTRAINT dept_emp_dept_no_fkey;

ALTER TABLE dept_emp DROP CONSTRAINT dept_emp_emp_no_fkey;

ALTER TABLE dept_emp
ADD CONSTRAINT dept_emp_emp_no_fkey FOREIGN KEY (emp_no) REFERENCES employee(emp_no) ON DELETE CASCADE NOT VALID;

ALTER TABLE dept_emp VALIDATE CONSTRAINT dept_emp_emp_no_fkey;

ALTER TABLE dept_manager DROP CONSTRAINT dept_manager_dept_no_fkey;

ALTER TABLE dept_manager
ADD CONSTRAINT dept_manager_dept_no_fkey FOREIGN KEY (dept_no) REFERENCES department(dept_no) ON DELETE CASCADE NOT VALID;

ALTER TABLE dept_manager VALIDATE CONSTRAINT dept_manager_dept_no_fkey;

ALTER TABLE dept_manager DROP CONSTRAINT dept_manager_emp_no_fkey;

ALTER TABLE dept_manager
ADD CONSTRAINT dept_manager_emp_no_fkey FOREIGN KEY (emp_no) REFERENCES employee(emp_no) ON DELETE CASCADE NOT VALID;

ALTER TABLE dept_manager VALIDATE CONSTRAINT dept_manager_emp_no_fkey;

ALTER TABLE employee
ADD CONSTRAINT employee_gender_check CHECK (gender IN ('M', 'F')) NOT VALID;

ALTER TABLE employee VALIDATE CONSTRAINT employee_gender_check;

-- Transaction Group #2
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_employee_hire_date ON employee (hire_date);

-- Transaction Group #3
-- pgschema:wait
SELECT 
    COALESCE(i.indisvalid, false) as done,
    CASE 
        WHEN p.blocks_total > 0 THEN p.blocks_done * 100 / p.blocks_total
        ELSE 0
    END as progress
FROM pg_class c
LEFT JOIN pg_index i ON c.oid = i.indexrelid
LEFT JOIN pg_stat_progress_create_index p ON c.oid = p.index_relid
WHERE c.relname = 'idx_employee_hire_date';

-- Transaction Group #4
ALTER TABLE salary DROP CONSTRAINT salary_emp_no_fkey;

ALTER TABLE salary
ADD CONSTRAINT salary_emp_no_fkey FOREIGN KEY (emp_no) REFERENCES employee(emp_no) ON DELETE CASCADE NOT VALID;

ALTER TABLE salary VALIDATE CONSTRAINT salary_emp_no_fkey;

-- Transaction Group #5
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_salary_amount ON salary (amount);

-- Transaction Group #6
-- pgschema:wait
SELECT 
    COALESCE(i.indisvalid, false) as done,
    CASE 
        WHEN p.blocks_total > 0 THEN p.blocks_done * 100 / p.blocks_total
        ELSE 0
    END as progress
FROM pg_class c
LEFT JOIN pg_index i ON c.oid = i.indexrelid
LEFT JOIN pg_stat_progress_create_index p ON c.oid = p.index_relid
WHERE c.relname = 'idx_salary_amount';

-- Transaction Group #7
ALTER TABLE title DROP CONSTRAINT title_emp_no_fkey;

ALTER TABLE title
ADD CONSTRAINT title_emp_no_fkey FOREIGN KEY (emp_no) REFERENCES employee(emp_no) ON DELETE CASCADE NOT VALID;

ALTER TABLE title VALIDATE CONSTRAINT title_emp_no_fkey;
